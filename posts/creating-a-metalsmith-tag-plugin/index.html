<html>
<head>
  <title>Creating a Metalsmith tag plugin</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="../../css/theme.css"/>
  <link rel="stylesheet" href="../../css/highlight.css">
</head>
<body>

<header class="site-head" >
  <div class="container">
    <!-- Vertically center -->
    <div class="vertical">
      <div class="site-head-content inner">
        
          <h1 class="blog-title"><a href="../../">Krawaller</a></h1>
        
        <h2 class="blog-description">
          <ul class="social-nav">
            <li class="twitter"><a href="http://www.twitter.com/krawaller">Twitter</a></li>
            <li class="github"><a href="http://www.github.com/krawaller">Github</a></li>
            <li class="mail"><a href="mailto:info@krawaller.se">Mail</a></li>
          </ul>
        </h2>
      </div>
    </div><!-- END .vertical -->
  </div><!-- END .container -->
</header>
<div class="sub-head">
  <div class="container">
    A walkthrough of creating a tag plugin for Metalsmith
  </div>
</div><!-- END .sub-head -->


<div class="container">
  <main class="content" role="main">
    <article class="">
      <header class="post-header">
        <h2 class="post-title">
          <a href="./.">Creating a Metalsmith tag plugin</a>
          <span class="post-meta">
            <time datetime="Sat Aug 09 2014 02:00:00 GMT+0200 (CEST)">Aug 9th 2014</time> 
          </span>
        </h2>
          <div class='tags'>
            By: <span><a href='../../author/david'>David</a></span>
          </div>
          <div class="tags">
            Tags:
            
              <span><a href='../../tags/metalsmith/'>metalsmith</a></span>
            
          </div>
      </header>
      <section class="post-content">
        <h2 id="creating-the-plugin">Creating the plugin</h2>
<p>When we first set up this blog, there was no tag plugin for Metalsmith. Now there is a <a href="https://github.com/totocaster/metalsmith-tags">pretty solid-looking one</a>, but we had to roll our own. This post walks through that code, serving mostly as a rundown of how to create a Metalsmith plugin.</p>
<p>Metalsmith is mostly used as a static site generator, but it is really an all-purpose tool for iterating over files in a folder structure and doing something with them. Everything you want to do is a plugin. Here&#39;s what the Metalsmith code looks like for generating this blog:</p>
<pre><code>Metalsmith(__dirname)
  .use(collections({articles: {pattern:<span class="string">'posts/*.md'</span>,sortBy:<span class="string">"date"</span>,reverse:<span class="literal">true</span>}}))
  .use(tags({path:<span class="string">"tags/"</span>}))
  .use(metallic({classPrefix:<span class="string">''</span>}))
  .use(markdown())
  .use(sass({outputStyle:<span class="string">"expanded"</span>}))
  .use(permalinks({pattern: <span class="string">'posts/:title'</span>}))
  .use(templates({engine: <span class="string">'handlebars'</span>,directory: <span class="string">'./templates'</span>}))
  .source(<span class="string">'./files'</span>)
  .destination(<span class="string">'../.'</span>)
  .build(<span class="function"><span class="keyword">function</span><span class="params">(e,h)</span>{</span><span class="keyword">if</span> (e){<span class="keyword">throw</span> e;}});</code></pre>

<p>Each <code>use</code> call is a plugin. Abstracting the actual file transformations to plugins is a very conscious call made by Metalsmith creators, serving to keep the Metalsmith API very small and lean.</p>
<p>Note the second row, <code>.use(tags({...}))</code>. That&#39;s our plugin! As you can see, each plugin is actually a function, that takes an options object for an argument.</p>
<p>Here&#39;s the skeleton of the plugin code:</p>
<pre><code>tags= <span class="function"><span class="keyword">function</span><span class="params">(opts)</span>{</span>

  <span class="comment">// commonly set default options here</span>

  <span class="comment">// return the function to be given to the `.use` call.</span>
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(files, metalsmith, done)</span>{</span>

    <span class="comment">// ...do something with `files` here...</span>

    done();
  };
};</code></pre>

<p>The plugin function is given three arguments:</p>
<ul>
<li>The <code>files</code> object given to the plugin function contains information of all processed files so far. The keys are the paths to the files. A plugin commonly loops through all these files, editing them accordingly. </li>
<li>The <code>metalsmith</code> object exposes the Metalsmith API. A common usecase is to access the metadata through <code>metalsmith.metadata()</code> and read/edit that.</li>
<li>To allow plugins to do asynchronous stuff, control isn&#39;t handed back to Metalsmith until the <code>done</code> callback is called.</li>
</ul>
<p>Each <code>file</code> object contains the contents of the file, and also information from optional YAML frontmatter. For example, here&#39;s the YAML for this very blog post:</p>
<pre><code><span class="bullet">---
</span>title: Creating a Metalsmith tag plugin
author: David
tags: [metalsmith]
date: 2014-08-09
excerpt: A walkthrough of creating a tag plugin for Metalsmith
<span class="header">template: post.html
---</span></code></pre>

<p>Note the <code>tags</code> data - that&#39;s of course meant to be consumed by our tags plugin! </p>
<p>First we need to consider what we actually want our plugin to do. What we need are two things;</p>
<ul>
<li>We want to add a page for each tag, listing all posts for that tag. These files need to be generated by the plugin.</li>
<li>We want to add a page listing all tags found in the blog, along with a post count for each tag. The plugin could generate this file, or simply expose data making such a file easy to set up. We&#39;ve elected to go with the latter, as there&#39;s too many decisions going into creating such a file.</li>
</ul>
<p>Here&#39;s the full code for our tag plugin, meeting the needs outlined above:</p>
<pre><code>tags= <span class="function"><span class="keyword">function</span><span class="params">(opts)</span>{</span>
  opts = _.defaults(opts||{},{path:<span class="string">"tags/"</span>,yaml:{template:<span class="string">"tag.html"</span>}});
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(files, metalsmith, done)</span>{</span>
    meta = metalsmith.metadata();

    <span class="comment">// loop through all files, building an object with data about all tags</span>
    <span class="keyword">var</span> tags = _.reduce(files,<span class="function"><span class="keyword">function</span><span class="params">(memo,file,path)</span>{</span>
      <span class="comment">// make sure all tags are lower case, to prevent distinction between `Backbone` and `backbone`.</span>
      file.tags = file.tags ? _.map(file.tags,<span class="function"><span class="keyword">function</span><span class="params">(t)</span>{</span><span class="keyword">return</span> t.toLowerCase();}) : [];
      <span class="comment">// loop through all tags found in the `tags` YAML data for this file</span>
      _.each(file.tags,<span class="function"><span class="keyword">function</span><span class="params">(tag)</span>{</span>
        <span class="comment">// build a path for where the file for this tag is supposed to go</span>
        key = opts.path+tag+<span class="string">"/index.html"</span>;
        memo[key] = _.defaults({},memo[key],{tag:tag,posts:[],contents:<span class="string">""</span>},opts.yaml);
        memo[key].posts = _.sortBy(memo[key].posts.concat(file),<span class="string">"date"</span>).reverse();
      });
      <span class="keyword">return</span> memo;
    },{});

    <span class="comment">// add this data to the files object, causing Metalsmith to create these files</span>
    _.extend(files,tags);

    <span class="comment">// add a taglist array to the metadata, to be consumed by a tagcloud type page</span>
    meta.taglist = _.sortBy(_.reduce(tags,<span class="function"><span class="keyword">function</span><span class="params">(memo,tag)</span>{</span>
      <span class="keyword">return</span> memo.concat({tag:tag.tag,count:tag.posts.length,posts:tag.posts});
    },[]),<span class="string">"count"</span>).reverse();

    <span class="comment">// also add the same data but with tagnames as key, for use by individual tag pages</span>
    meta.tags = _.reduce(tags,<span class="function"><span class="keyword">function</span><span class="params">(memo,tag)</span>{</span>
      memo[tag.tag] = {tag:tag.tag,count:tag.posts.length,posts:tag.posts};
      <span class="keyword">return</span> memo;
    },{});

    <span class="comment">// note metalsmith that we are done!</span>
    done();
  };
};</code></pre>

<h2 id="consuming-the-plugin">Consuming the plugin</h2>
<p>First off, individual blog posts will print out the individual tags by simply reading from the YAML <code>tags</code> array:</p>
<pre><code><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"tags"</span>&gt;</span>
Tags:
{{#each tags}}
  <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">'../../tags/{{this}}/'</span>&gt;</span>{{this}}<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
{{/each}}
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre>

<p>Our taglist page contains this code, using the <code>taglist</code> metadata added by our plugin:</p>
<pre><code><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">'tags'</span>&gt;</span>
  Tags:
  {{#each this.taglist}}
  <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">'../tags/{{tag}}/'</span>&gt;</span>{{tag}} ({{count}})<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
  {{/each}}
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre>

<p>The main code powering the individual tag pages will be in the html template file. Note that we added a default to the <code>opts</code> object, telling Metalsmith to use a <code>tags.html</code> file for these pages. The <code>contents</code> was merely set to an empty string - we need to have a contents specification, otherwise Metalsmith will simply skip over generating a file.</p>
<p>Inside the template we have access to the variables set in the <code>files[tagname]</code> object. This means we can do this in the template file:</p>
<pre><code><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container"</span>&gt;</span>
  Posts about {{tag}}:
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre>

<p>For these individual pages we also created a Handlebars helper, to avoid having to put too much logic into the template file. Here&#39;s how we consume it in the template:</p>
<pre><code>{{#tagPosts tag}}

<span class="tag">&lt;<span class="title">article</span> <span class="attribute">class</span>=<span class="value">"{{post_class}}"</span>&gt;</span>
  <span class="tag">&lt;<span class="title">header</span> <span class="attribute">class</span>=<span class="value">"post-header"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">h2</span> <span class="attribute">class</span>=<span class="value">"post-title"</span>&gt;</span>
      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"../../{{path}}"</span>&gt;</span>{{{title}}}<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
      <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"post-meta"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">time</span> <span class="attribute">datetime</span>=<span class="value">"{{date}}"</span>&gt;</span>{{moment date 'MMM Do YYYY'}}<span class="tag">&lt;/<span class="title">time</span>&gt;</span> 
      <span class="tag">&lt;/<span class="title">span</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
      <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">'tags'</span>&gt;</span>
        By: <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">'../../author/{{toLowerCase author}}'</span>&gt;</span>{{author}}<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
      <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
      <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"tags"</span>&gt;</span>
        Tags:
        {{#each tags}}
          <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">'../../tags/{{this}}/'</span>&gt;</span>{{this}}<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
        {{/each}}
      <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">header</span>&gt;</span>
  <span class="tag">&lt;<span class="title">section</span> <span class="attribute">class</span>=<span class="value">"post-excerpt"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">p</span>&gt;</span>{{excerpt}}<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">section</span>&gt;</span>
<span class="tag">&lt;/<span class="title">article</span>&gt;</span>

{{else}}
<span class="tag">&lt;<span class="title">section</span> <span class="attribute">class</span>=<span class="value">"post-content"</span>&gt;</span>{{portrait}} hasn't written any posts yet!<span class="tag">&lt;/<span class="title">section</span>&gt;</span>
{{/tagPosts}}</code></pre>

<p>And here&#39;s the source for the <code>tagPosts</code> helper, which uses the <code>tags</code> property of the metadata to look up the corresponding information:</p>
<pre><code>Handlebars.registerHelper(<span class="string">'tagPosts'</span>, <span class="function"><span class="keyword">function</span><span class="params">(tagname, options)</span> {</span>
  <span class="keyword">return</span> _.reduce(<span class="keyword">this</span>.tags[tagname].posts,<span class="function"><span class="keyword">function</span><span class="params">(memo,f)</span>{</span>
    <span class="keyword">return</span> memo+options.fn(f);
  },<span class="string">""</span>);
});</code></pre>
      </section>
    </article>
  </main><!-- END role="main" -->
</div><!-- END .container -->


</body>
</html>